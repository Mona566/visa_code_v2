# insert_brower.py é€»è¾‘æ¢³ç†æ–‡æ¡£

## ğŸ“‹ æ–‡ä»¶æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Selenium WebDriver è‡ªåŠ¨å¡«å†™çˆ±å°”å…°ç­¾è¯ç”³è¯·è¡¨çš„ Python è„šæœ¬ã€‚è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨å¯¼èˆªã€å¡«å†™è¡¨å•ã€å¤„ç†é”™è¯¯ï¼Œå¹¶æ”¯æŒåº”ç”¨æ¢å¤åŠŸèƒ½ã€‚

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### 1. **å…¥å£å‡½æ•°**
```
auto_fill_inis_form() 
    â†“
fill_application_form()
    â†“
fill_page_1() â†’ fill_page_2() â†’ ... â†’ fill_page_9()
```

### 2. **æ ¸å¿ƒæ¨¡å—åˆ†ç±»**

#### A. **é…ç½®ä¸æ—¥å¿—æ¨¡å—**
- `OPERATION_DELAY`: æ“ä½œå»¶è¿Ÿï¼ˆ1.5ç§’ï¼‰
- `POSTBACK_DELAY`: PostBack æ“ä½œå»¶è¿Ÿï¼ˆ2.0ç§’ï¼‰
- `log_operation()`: ç»Ÿä¸€æ—¥å¿—è®°å½•å‡½æ•°
- `setup_logging()`: æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–

#### B. **é¡µé¢çŠ¶æ€æ£€æµ‹æ¨¡å—**
- `check_homepage_redirect()`: æ£€æµ‹æ˜¯å¦é‡å®šå‘åˆ°é¦–é¡µ
- `check_and_handle_error_page()`: æ£€æµ‹å¹¶å¤„ç†é”™è¯¯é¡µé¢ï¼ˆæ”¯æŒè‡ªåŠ¨åˆ·æ–°é‡è¯•ï¼‰
- `check_application_error()`: æ£€æµ‹åº”ç”¨é”™è¯¯
- `detect_current_page_state()`: æ£€æµ‹å½“å‰é¡µé¢çŠ¶æ€ï¼ˆé¦–é¡µ/è¡¨å•é¡µ/ä¸­é—´é¡µï¼‰
- `detect_page_number_no_refresh()`: æ£€æµ‹å½“å‰è¡¨å•é¡µç ï¼ˆ1-9ï¼‰

#### C. **åº”ç”¨æ¢å¤æ¨¡å—**
- `get_saved_application_number()`: ä»æ–‡ä»¶è¯»å–ä¿å­˜çš„ç”³è¯·å·
- `save_application_number()`: ä¿å­˜ç”³è¯·å·åˆ°æ–‡ä»¶
- `extract_application_number()`: ä»é¡µé¢æå–ç”³è¯·å·
- `retrieve_application()`: ä½¿ç”¨ç”³è¯·å·æ¢å¤å·²ä¿å­˜çš„ç”³è¯·

#### D. **è¡¨å•å¡«å†™æ¨¡å—**
- `fill_application_form()`: ä¸»è¡¨å•å¡«å†™æµç¨‹æ§åˆ¶å™¨
- `fill_page_1()` ~ `fill_page_9()`: å„é¡µé¢å¡«å†™å‡½æ•°
- `click_next_button()`: ç‚¹å‡»"ä¿å­˜å¹¶ç»§ç»­"æŒ‰é’®

#### E. **å…ƒç´ æ“ä½œè¾…åŠ©æ¨¡å—**
- `fill_text_by_label()`: é€šè¿‡æ ‡ç­¾æŸ¥æ‰¾å¹¶å¡«å†™æ–‡æœ¬å­—æ®µ
- `fill_dropdown_by_label()`: é€šè¿‡æ ‡ç­¾æŸ¥æ‰¾å¹¶é€‰æ‹©ä¸‹æ‹‰æ¡†
- `select_radio_by_label()`: é€šè¿‡æ ‡ç­¾æŸ¥æ‰¾å¹¶é€‰æ‹©å•é€‰æŒ‰é’®
- `fill_date_by_label()`: é€šè¿‡æ ‡ç­¾æŸ¥æ‰¾å¹¶å¡«å†™æ—¥æœŸå­—æ®µ

#### F. **é¡µé¢å¯¼èˆªæ¨¡å—**
- `handle_intermediate_page()`: å¤„ç†ä¸­é—´é¡µé¢ï¼ˆOnlineHome2.aspxï¼‰
- `restart_from_homepage()`: ä»é¦–é¡µé‡æ–°å¼€å§‹æµç¨‹
- `verify_page_state()`: éªŒè¯é¡µé¢çŠ¶æ€
- `safe_postback_operation()`: å®‰å…¨çš„ PostBack æ“ä½œåŒ…è£…å™¨

---

## ğŸ”„ ä¸»è¦æ‰§è¡Œæµç¨‹

### é˜¶æ®µ 1: åˆå§‹åŒ–ä¸å¯¼èˆª

```
1. auto_fill_inis_form()
   â”œâ”€ å¯åŠ¨ Chrome æµè§ˆå™¨
   â”œâ”€ è®¿é—®ç›®æ ‡ URL: VisaTypeDetails.aspx
   â”œâ”€ æ£€æŸ¥é”™è¯¯é¡µé¢
   â””â”€ åˆ¤æ–­å½“å‰é¡µé¢çŠ¶æ€
       â”œâ”€ å¦‚æœåœ¨é¦–é¡µ (OnlineHome.aspx)
       â”‚   â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”³è¯·å·
       â”‚   â”œâ”€ å¦‚æœæœ‰ â†’ è°ƒç”¨ retrieve_application()
       â”‚   â””â”€ å¦‚æœæ²¡æœ‰ â†’ ç‚¹å‡» "Continue" æŒ‰é’®
       â””â”€ å¦‚æœå·²åœ¨è¡¨å•é¡µ â†’ ç›´æ¥è¿›å…¥å¡«å†™æµç¨‹
```

### é˜¶æ®µ 2: è¡¨å•å¡«å†™æµç¨‹

```
2. fill_application_form()
   â”œâ”€ æ£€æŸ¥é¡µé¢çŠ¶æ€å’Œé”™è¯¯
   â”œâ”€ åˆå§‹åŒ–é¡µé¢æ˜ å°„è¡¨
   â”‚   page_fill_functions = {
   â”‚       1: fill_page_1,
   â”‚       2: fill_page_2,
   â”‚       ...
   â”‚       9: fill_page_9
   â”‚   }
   â”‚
   â””â”€ å¾ªç¯å¡«å†™é¡µé¢ (current_page = 1 to 9)
       â”œâ”€ è°ƒç”¨ fill_page_X()
       â”œâ”€ å¤„ç†è¿”å›å€¼:
       â”‚   â”œâ”€ "success" â†’ current_page += 1 (ç»§ç»­ä¸‹ä¸€é¡µ)
       â”‚   â”œâ”€ "homepage_redirect" â†’ è°ƒç”¨ restart_from_homepage()
       â”‚   â”œâ”€ "application_error" â†’ åœæ­¢å¡«å†™
       â”‚   â”œâ”€ "form_page_X" â†’ è·³è½¬åˆ°æŒ‡å®šé¡µé¢
       â”‚   â””â”€ "same_page" â†’ åˆ·æ–°é¡µé¢ï¼Œæ£€æµ‹å½“å‰é¡µï¼Œç»§ç»­å¡«å†™
       â””â”€ é‡å¤ç›´åˆ°å®Œæˆæ‰€æœ‰é¡µé¢
```

### é˜¶æ®µ 3: å•é¡µé¢å¡«å†™æµç¨‹

```
3. fill_page_X() (ä»¥ fill_page_1 ä¸ºä¾‹)
   â”œâ”€ æ£€æŸ¥é¦–é¡µé‡å®šå‘
   â”œâ”€ ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
   â”œâ”€ å¡«å†™å„ä¸ªå­—æ®µ
   â”‚   â”œâ”€ ä½¿ç”¨ fill_text_by_label()
   â”‚   â”œâ”€ ä½¿ç”¨ fill_dropdown_by_label()
   â”‚   â”œâ”€ ä½¿ç”¨ select_radio_by_label()
   â”‚   â””â”€ ä½¿ç”¨ fill_date_by_label()
   â”œâ”€ æ£€æŸ¥é”™è¯¯é¡µé¢
   â”œâ”€ ç‚¹å‡» "Save and Continue" æŒ‰é’®
   â”‚   â””â”€ è°ƒç”¨ click_next_button()
   â””â”€ å¤„ç†æŒ‰é’®ç‚¹å‡»ç»“æœ
       â”œâ”€ "success" â†’ è¿”å› "success"
       â”œâ”€ "homepage" â†’ æ£€æµ‹é¡µé¢çŠ¶æ€ï¼Œè¿”å›ç›¸åº”çŠ¶æ€
       â”œâ”€ "same_page" â†’ åˆ·æ–°é¡µé¢ï¼Œæ£€æµ‹å½“å‰é¡µï¼Œè¿”å› "form_page_X"
       â””â”€ "application_error" â†’ è¿”å› "application_error"
```

---

## ğŸ”‘ å…³é”®æœºåˆ¶

### 1. **é”™è¯¯å¤„ç†ä¸æ¢å¤æœºåˆ¶**

#### A. é”™è¯¯é¡µé¢æ£€æµ‹ä¸è‡ªåŠ¨åˆ·æ–°
```python
check_and_handle_error_page()
â”œâ”€ æ£€æµ‹é”™è¯¯å…³é”®è¯
â”œâ”€ å¦‚æœå‘ç°é”™è¯¯ â†’ è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼ˆæœ€å¤š5æ¬¡ï¼‰
â”œâ”€ åˆ·æ–°åæ£€æµ‹é¡µé¢çŠ¶æ€
â””â”€ è¿”å›:
    â”œâ”€ "application_error" (é”™è¯¯æŒç»­)
    â”œâ”€ "homepage_redirect" (é‡å®šå‘åˆ°é¦–é¡µ)
    â””â”€ "form_page_X" (é”™è¯¯è§£å†³ï¼Œè¿”å›è¡¨å•é¡µX)
```

#### B. Stale Element å¤„ç†
- åœ¨ `fill_page_8` å’Œ `fill_page_9` ä¸­å®ç°é‡è¯•æœºåˆ¶
- ä½¿ç”¨ `EC.element_to_be_clickable` æ›¿ä»£ `EC.presence_of_element_located`
- åœ¨æ“ä½œå‰é‡æ–°æŸ¥æ‰¾å…ƒç´ ï¼Œé¿å…å¼•ç”¨å¤±æ•ˆ

### 2. **åº”ç”¨æ¢å¤æœºåˆ¶**

```
ä¿å­˜çš„ç”³è¯·å·æµç¨‹:
1. åœ¨ fill_page_4 æˆ– fill_page_5 æäº¤å
   â””â”€ extract_application_number() æå–ç”³è¯·å·
   â””â”€ save_application_number() ä¿å­˜åˆ°æ–‡ä»¶

2. ä¸‹æ¬¡è¿è¡Œæ—¶
   â””â”€ get_saved_application_number() è¯»å–æ–‡ä»¶
   â””â”€ retrieve_application() æ¢å¤ç”³è¯·
       â”œâ”€ ç‚¹å‡» "Retrieve Application" é“¾æ¥
       â”œâ”€ å¡«å†™ç”³è¯·å·ã€æŠ¤ç…§å·ã€å›½ç±ã€å‡ºç”Ÿæ—¥æœŸ
       â””â”€ æäº¤åè·³è½¬åˆ°è¡¨å•é¡µ
```

### 3. **é¡µé¢è·³è½¬æ£€æµ‹æœºåˆ¶**

```
å½“ click_next_button() è¿”å› "same_page" æ—¶:
1. fill_page_X() åˆ·æ–°é¡µé¢
2. detect_page_number_no_refresh() æ£€æµ‹å½“å‰é¡µç 
3. è¿”å› "form_page_X"
4. fill_application_form() è·³è½¬åˆ°æ£€æµ‹åˆ°çš„é¡µé¢ç»§ç»­å¡«å†™
```

### 4. **å…ƒç´ æŸ¥æ‰¾ç­–ç•¥**

#### A. æ–‡æœ¬å­—æ®µ (fill_text_by_label)
```
1. é€šè¿‡æ ‡ç­¾æ–‡æœ¬æŸ¥æ‰¾ label
2. é€šè¿‡ label çš„ "for" å±æ€§æ‰¾åˆ° input
3. å¦‚æœå¤±è´¥ï¼ŒæŸ¥æ‰¾ label é™„è¿‘çš„ input
4. å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…
```

#### B. ä¸‹æ‹‰æ¡† (fill_dropdown_by_label)
```
1. ç›´æ¥ ID/name åŒ¹é…
2. é€šè¿‡æ ‡ç­¾æŸ¥æ‰¾
3. ä½¿ç”¨ Select ç±»æ“ä½œ
4. æ”¯æŒé‡è¯•æœºåˆ¶ï¼ˆfill_page_8ï¼‰
```

#### C. å•é€‰æŒ‰é’® (select_radio_by_label)
```
1. å®Œæ•´æ–‡æœ¬åŒ¹é…
2. éƒ¨åˆ†æ–‡æœ¬åŒ¹é…ï¼ˆå‰30å­—ç¬¦ï¼‰
3. å…³é”®è¯åŒ¹é…ï¼ˆé•¿åº¦>4çš„è¯ï¼‰
4. æŸ¥æ‰¾é™„è¿‘çš„ radio æŒ‰é’®
5. æ”¯æŒé‡è¯•æœºåˆ¶ï¼ˆfill_page_9ï¼‰
```

#### D. æ—¥æœŸå­—æ®µ (fill_date_by_label)
```
1. é€šè¿‡æ ‡ç­¾æŸ¥æ‰¾
2. è¯†åˆ«æ—¥æœŸå­—æ®µç±»å‹ï¼ˆFrom/To/Issue/Expiryï¼‰
3. é€šè¿‡ ID/name å…³é”®è¯åŒ¹é…ï¼ˆåŒ…å« "from", "to", "issue", "expiry"ï¼‰
4. å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨æ‰€æœ‰æ–‡æœ¬è¾“å…¥ä½œä¸ºåå¤‡
```

---

## ğŸ“Š æ•°æ®æµ

### ç”³è¯·å·æ•°æ®æµ
```
é¡µé¢æå– â†’ save_application_number() â†’ application_number.txt
                                    â†“
get_saved_application_number() â† æ–‡ä»¶è¯»å–
                                    â†“
retrieve_application() â†’ æ¢å¤ç”³è¯·
```

### é¡µé¢çŠ¶æ€æ•°æ®æµ
```
é¡µé¢æ“ä½œ â†’ click_next_button() â†’ è¿”å›çŠ¶æ€ç 
                              â†“
fill_page_X() â†’ å¤„ç†çŠ¶æ€ç  â†’ è¿”å›æ–°çŠ¶æ€
                              â†“
fill_application_form() â†’ æ ¹æ®çŠ¶æ€è°ƒæ•´ current_page
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†ç­–ç•¥

### 1. **é¡µé¢çº§é”™è¯¯**
- **é”™è¯¯é¡µé¢**: è‡ªåŠ¨åˆ·æ–°ï¼ˆæœ€å¤š5æ¬¡ï¼‰
- **é¦–é¡µé‡å®šå‘**: æ£€æµ‹å¹¶è°ƒç”¨ `restart_from_homepage()`
- **éªŒè¯é”™è¯¯**: åˆ·æ–°é¡µé¢ï¼Œæ£€æµ‹å½“å‰é¡µï¼Œç»§ç»­å¡«å†™

### 2. **å…ƒç´ çº§é”™è¯¯**
- **Stale Element**: é‡æ–°æŸ¥æ‰¾å…ƒç´ 
- **å…ƒç´ æœªæ‰¾åˆ°**: å°è¯•å¤šç§é€‰æ‹©å™¨ç­–ç•¥
- **æ“ä½œå¤±è´¥**: è®°å½•è­¦å‘Šï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå­—æ®µ

### 3. **æµç¨‹çº§é”™è¯¯**
- **åº”ç”¨é”™è¯¯**: åœæ­¢æ‰€æœ‰å¡«å†™æ“ä½œ
- **è¶…æ—¶**: å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œé‡è¯•
- **æ„å¤–è·³è½¬**: æ£€æµ‹å½“å‰é¡µï¼Œè°ƒæ•´å¡«å†™æµç¨‹

---

## ğŸ”§ é…ç½®å‚æ•°

```python
OPERATION_DELAY = 1.5          # æ™®é€šæ“ä½œå»¶è¿Ÿ
POSTBACK_DELAY = 2.0           # PostBack å‰å»¶è¿Ÿ
POSTBACK_WAIT_DELAY = 3.0      # PostBack åç­‰å¾…
POSTBACK_BETWEEN_DELAY = 2.5   # PostBack ä¹‹é—´å»¶è¿Ÿ
```

---

## ğŸ“ å‡½æ•°è°ƒç”¨å…³ç³»å›¾

```
auto_fill_inis_form()
â”œâ”€ check_and_handle_error_page()
â”œâ”€ get_saved_application_number()
â”œâ”€ retrieve_application()
â”‚   â”œâ”€ fill_text_by_label()
â”‚   â”œâ”€ fill_dropdown_by_label()
â”‚   â””â”€ click_next_button()
â””â”€ fill_application_form()
    â”œâ”€ check_and_handle_error_page()
    â”œâ”€ detect_current_page_state()
    â”œâ”€ retrieve_application() [å¯é€‰]
    â””â”€ fill_page_1() ~ fill_page_9()
        â”œâ”€ check_homepage_redirect()
        â”œâ”€ check_and_handle_error_page()
        â”œâ”€ fill_text_by_label()
        â”œâ”€ fill_dropdown_by_label()
        â”œâ”€ select_radio_by_label()
        â”œâ”€ fill_date_by_label()
        â”œâ”€ click_next_button()
        â”‚   â”œâ”€ verify_page_state()
        â”‚   â”œâ”€ check_and_handle_error_page()
        â”‚   â””â”€ detect_current_page_state()
        â”œâ”€ detect_page_number_no_refresh() [å¦‚æœ same_page]
        â””â”€ extract_application_number() [page 4/5]
            â””â”€ save_application_number()
```

---

## ğŸ¯ å…³é”®è®¾è®¡æ¨¡å¼

### 1. **çŠ¶æ€æœºæ¨¡å¼**
- é¡µé¢çŠ¶æ€: homepage â†’ form_page â†’ next_page
- å¡«å†™çŠ¶æ€: success â†’ same_page â†’ error â†’ redirect

### 2. **ç­–ç•¥æ¨¡å¼**
- å¤šç§å…ƒç´ æŸ¥æ‰¾ç­–ç•¥ï¼ˆID â†’ XPath â†’ Label â†’ Keywordï¼‰
- å¤šç§é€‰æ‹©ç­–ç•¥ï¼ˆvisible_text â†’ value â†’ indexï¼‰

### 3. **é‡è¯•æ¨¡å¼**
- é”™è¯¯é¡µé¢è‡ªåŠ¨åˆ·æ–°é‡è¯•
- Stale element é‡è¯•
- æ“ä½œå¤±è´¥é‡è¯•

### 4. **è§‚å¯Ÿè€…æ¨¡å¼**
- é¡µé¢çŠ¶æ€å˜åŒ–æ£€æµ‹
- é”™è¯¯æ£€æµ‹ä¸å¤„ç†

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ç”³è¯·å·æå–æ—¶æœº**: åªåœ¨ fill_page_4 å’Œ fill_page_5 æäº¤åæå–
2. **é¡µé¢è·³è½¬å¤„ç†**: ä½¿ç”¨ `detect_page_number_no_refresh()` é¿å…é‡å¤åˆ·æ–°
3. **Stale Element**: åœ¨æ“ä½œå‰é‡æ–°æŸ¥æ‰¾å…ƒç´ 
4. **é”™è¯¯æ¢å¤**: æ”¯æŒä»ä»»æ„é¡µé¢æ¢å¤å¡«å†™æµç¨‹
5. **æ—¥å¿—è®°å½•**: æ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

---

## ğŸ”„ å…¸å‹æ‰§è¡Œåœºæ™¯

### åœºæ™¯ 1: é¦–æ¬¡å¡«å†™
```
é¦–é¡µ â†’ Continue â†’ è¡¨å•é¡µ1 â†’ ... â†’ è¡¨å•é¡µ9 â†’ å®Œæˆ
```

### åœºæ™¯ 2: æ¢å¤ç”³è¯·
```
é¦–é¡µ â†’ Retrieve Application â†’ å¡«å†™ç”³è¯·å· â†’ è¡¨å•é¡µX â†’ ç»§ç»­å¡«å†™
```

### åœºæ™¯ 3: é”™è¯¯æ¢å¤
```
è¡¨å•é¡µX â†’ é”™è¯¯é¡µé¢ â†’ è‡ªåŠ¨åˆ·æ–° â†’ è¡¨å•é¡µY â†’ ç»§ç»­å¡«å†™
```

### åœºæ™¯ 4: éªŒè¯é”™è¯¯
```
è¡¨å•é¡µX â†’ ç‚¹å‡»Next â†’ ä»åœ¨Xé¡µ â†’ åˆ·æ–° â†’ æ£€æµ‹åˆ°Yé¡µ â†’ ç»§ç»­å¡«å†™Yé¡µ
```

---

## ğŸ“š æ–‡ä»¶ç»“æ„æ€»ç»“

```
insert_brower.py (9174è¡Œ)
â”œâ”€ é…ç½®ä¸æ—¥å¿— (1-61è¡Œ)
â”œâ”€ é¡µé¢çŠ¶æ€æ£€æµ‹ (62-1103è¡Œ)
â”œâ”€ åº”ç”¨æ¢å¤ (1104-1250è¡Œ)
â”œâ”€ ä¸»æµç¨‹ (1251-3323è¡Œ)
â”‚   â”œâ”€ auto_fill_inis_form()
â”‚   â””â”€ fill_application_form()
â”œâ”€ é¡µé¢å¡«å†™å‡½æ•° (3324-7373è¡Œ)
â”‚   â”œâ”€ fill_page_1() ~ fill_page_9()
â”‚   â””â”€ click_next_button()
â””â”€ è¾…åŠ©å‡½æ•° (7374-9170è¡Œ)
    â”œâ”€ fill_text_by_label()
    â”œâ”€ fill_dropdown_by_label()
    â”œâ”€ select_radio_by_label()
    â”œâ”€ fill_date_by_label()
    â”œâ”€ extract_application_number()
    â””â”€ retrieve_application()
```

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2025-12-19*
*æ–‡ä»¶ç‰ˆæœ¬: insert_brower.py (9174è¡Œ)*

